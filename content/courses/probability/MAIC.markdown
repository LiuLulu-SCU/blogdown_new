---
date: "2023-05-17"
title: MAIC
type: book
weight: 110
math: true
mathjax: "book/MathJax/MathJax.js"
---

## ç†è®ºçŸ¥è¯† 

å·²çŸ¥å¹²é¢„ç»„æ‚£è€…çš„ä¸ªä½“æ‚£è€…æ•°æ®ï¼ˆIPDï¼‰å’Œå¯¹ç…§ç»„æ‚£è€…çš„æ±‡æ€»æ•°æ®ã€‚

åˆ™å¹²é¢„ç»„å’Œå¯¹ç…§ç»„çš„å¹³å‡æ²»ç–—æ•ˆæœçš„å·®å€¼$\theta$ä¸º

$$
\hat{\theta}=\frac{\sum\limits_{i=1}^{n} y_i w_i} {\sum\limits_{i=1}^nw_i} -\bar{y_1} \tag{1}
$$
å…¶ä¸­$\hat{\theta}$è¡¨ç¤ºå¹³å‡å¤„ç†æ•ˆåº”çš„å·®å€¼ï¼›$y_i$è¡¨ç¤ºæœ‰IPDæ•°æ®ä¸´åºŠè¯•éªŒçš„ç»“æœï¼›$w_i$è¡¨ç¤ºIPDè¯•éªŒä¸­ç¬¬$i$ä½æ‚£è€…çš„æƒé‡ï¼›$\bar{y_1}$è¡¨ç¤ºæ±‡æ€»æ•°æ®ä¸´åºŠè¯•éªŒçš„ç»“æœã€‚

å…¬å¼ï¼ˆ1ï¼‰ä¸­ï¼Œ$w_i$ä¸çŸ¥é“ï¼Œéœ€å¾…æ±‚ã€‚


æ ¹æ®å€¾å‘æ€§è¯„åˆ†åŠ æƒçš„åŸç†ï¼Œ$w_i$ç­‰äºç¬¬$i$ä¸ªæ‚£è€…è¿›å…¥æ±‡æ€»æ•°æ®è¯•éªŒï¼ˆ$T_i=1$ï¼‰çš„æ¦‚ç‡æ¯”ä¸Šè¿›å…¥IPDæ•°æ®è¯•éªŒç»„ï¼ˆ$T_i=0$ï¼‰çš„æ¦‚ç‡ã€‚

$$
w_i=\frac{P(T_i=1|X_i)}{P(T_i=0|X_i)} \tag{2}
$$

å…¶ä¸­ï¼Œ$w_i$è¡¨ç¤ºIPDè¯•éªŒä¸­ç¬¬$i$ä½æ‚£è€…æƒé‡ï¼Œ$P(T_i=1|X_i)$ è¡¨ç¤ºè¯¥æ‚£è€…åœ¨ç»™å®šåŸºçº¿ç‰¹å¾$X_i$çš„æ¡ä»¶ä¸‹ï¼Œè¿›å…¥æ±‡æ€»è¯•éªŒç»„çš„æ¦‚ç‡ï¼Œå³å€¾å‘æ€§è¯„åˆ†ï¼ˆPSï¼‰ï¼Œ$P(T_i=0|X_i)$ è¡¨ç¤ºè¯¥æ‚£è€…åœ¨ç»™å®šåŸºçº¿ç‰¹å¾$X_i$çš„æ¡ä»¶ä¸‹ï¼Œè¿›å…¥IPDè¯•éªŒç»„çš„æ¦‚ç‡ï¼Œä¹Ÿç­‰äº$1-P(T_i=0|X_i)$ã€‚

å…¬å¼ï¼ˆ2ï¼‰ä¸­ï¼Œ$P(T_i=1|X_i)$å’Œ$P(T_i=0|X_i)$ä¸çŸ¥é“ï¼Œéœ€å¾…æ±‚ã€‚
å‡è®¾å¦‚æœæœ‰æ±‡æ€»æ•°æ®ç»„çš„ä¸ªä½“æ•°æ®ï¼Œé‚£ä¹ˆå¯ç”¨logisticså›å½’è®¡ç®—


$$
P(T_i=1|X_i)=\frac{e^{\beta_0 + \beta X_i}} {1+e^{\beta_0 +  \beta X_i}}  \tag{3}
$$


å…¶ä¸­ï¼Œ$\beta$ä»£è¡¨æ¯ä¸ªåå˜é‡çš„logisticçš„å›å½’ç³»æ•°ã€‚

$$
P(T_i=0|X_i)=1- P(T_i=1|X_i) = \frac{1} {1+e^{\beta_0 + \beta X_i}}   \tag{4}
$$
$$
w_i=\frac{P(T_i=1|X_i)}{P(T_i=0|X_i)} =\frac{e^{\beta_0 + \beta X_i}} {1+e^{\beta_0 + \beta X_i}} / \frac{1} {1+e^{\beta_0+\beta X_i}}=e^{\beta_0+\beta X_i} {\tag5}
$$

å°†å…¬å¼ï¼ˆ5ï¼‰å¸¦å…¥å…¬å¼ï¼ˆ1ï¼‰ä¸­ï¼š

$$
\hat{\theta}=\frac{\sum\limits_{i=1}^{n} y_i w_i} {\sum\limits_{i=1}^nw_i} -\bar{y_1}  =  
\frac{\sum\limits_{i=1}^{n} y_i e^{\beta_0+\beta X_i}} {\sum\limits_{i=1}^ne^{\beta_0+\beta X_i}} -\bar{y_1} =
\frac{e^{\beta_0} \sum\limits_{i=1}^{n} y_i e^{\beta X_i}} {e^{\beta_0}\sum\limits_{i=1}^ne^{\beta X_i}} -\bar{y_1}=
\frac{\sum\limits_{i=1}^{n} y_i e^{\beta X_i}} {\sum\limits_{i=1}^ne^{\beta X_i}} -\bar{y_1}
\tag{6}
$$

æ ¹æ®å…¬å¼ï¼ˆ6ï¼‰æˆ‘ä»¬å‘ç°ï¼Œåœ¨è®¡ç®—$\hat{\theta}$æ—¶ï¼Œ$\beta_0$è¢«æ¶ˆå»äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— éœ€ä¼°è®¡å‡º$\beta_0$ï¼Œè¿›ä¸€æ­¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸º$w_i=e^{\beta X_i}$ã€‚


è‡³æ­¤ï¼Œæ ¹æ®å…¬å¼ï¼ˆ6ï¼‰ï¼Œæˆ‘ä»¬å¾—å‡ºIPDè¯•éªŒæ‚£è€…çš„æƒé‡ç­‰äº$e^{\beta X_i} {\tag5}$ ï¼Œå…¶ä¸­$\beta$æœªçŸ¥ï¼Œå¾…æ±‚ã€‚

ç”±äºç¼ºä¹æ±‡æ€»å®éªŒæ•°æ®çš„IPDï¼Œæ— æ³•ä½¿ç”¨æœ€å¤§ä¼¼ç„¶ä¼°è®¡æ³•ï¼ˆMLEï¼‰ä¼°è®¡å‡º$\beta$ã€‚å› æ­¤ä½¿ç”¨çŸ©ä¼°è®¡æ³•æ±‚$\beta$ã€‚

å› ä¸ºå·²çŸ¥åŠ æƒåä¸¤ä¸ªè¯•éªŒï¼ˆIPDæ•°æ®è¯•éªŒå’Œæ±‡æ€»æ•°æ®è¯•éªŒï¼‰æ‚£è€…çš„åŸºçº¿åº”è¯¥æ˜¯å¹³è¡¡çš„ï¼Œå³ä¸¤ç»„åå˜é‡å‡å€¼ä¹‹å·®ä¸º0ï¼Œ æ‰€ä»¥å¾—å‡ºå…¬å¼ï¼ˆ7ï¼‰

$$
\frac{\sum\limits_{i=1}^{n} X_i w_i} {\sum\limits_{i=1}^nw_i} -\bar{X_1}=0 \tag{7}
$$

å…¶ä¸­ï¼Œ$\bar{X_1}$æ˜¯æ±‡æ€»æ•°æ®è¯•éªŒæ‚£è€…åŸºçº¿å˜é‡çš„å‡å€¼ã€‚

å°†$w_i=e^{\beta X_i}$å¸¦å…¥å…¬å¼ï¼ˆ7ï¼‰ï¼Œå¾—åˆ°
$$
\frac{\sum\limits_{i=1}^{n} X_i  e^{\beta X_i}} {\sum\limits_{i=1}^n e^{\beta X_i}} -\bar{X_1}=0 \tag{8}
$$


å°†å…¬å¼ï¼ˆ8ï¼‰ç­‰å¼ä¸¤è¾¹åŒä¹˜ç¬¬ä¸€é¡¹çš„åˆ†æ¯ï¼Œç„¶ååˆå¹¶åŒç±»é¡¹ï¼Œå¾—åˆ°

$$
\sum\limits_{i=1}^{n} X_i  e^{\beta X_i} - \sum\limits_{i=1}^{n}\bar{X_1}  e^{\beta X_i}
=\sum\limits_{i=1}^{n} (X_i-\bar{X_1})  e^{\beta X_i} 
=0  \tag{9}
$$

å‡è®¾å…¬å¼ï¼ˆ9ï¼‰ä¸­çš„$\bar{X_1}=0$ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹IPDè¯•éªŒç»„æ¯ä¸ªæ‚£è€…çš„åŸºçº¿è¿›è¡Œç¦»å·®å˜åŒ–ï¼ˆ$X_i-\bar{X_1}$ï¼‰å³å¯æ»¡è¶³æ­¤å‡è®¾ï¼Œå¾—åˆ°å…¬å¼ï¼ˆ10ï¼‰ã€‚


$$
\sum\limits_{i=1}^{n} X_i e^{\beta X_i} 
=0  \tag{10}
$$
æ³¨ï¼šå…¬å¼ï¼ˆ10ï¼‰ä¸­çš„$X_i$æ˜¯ç¦»å·®å˜æ¢åçš„IPDè¯•éªŒç»„çš„åŸºçº¿ç‰¹å¾ã€‚

è¿™é‡Œæˆ‘ä»¬å¼•å…¥ç›®æ ‡å‡½æ•°$Q(\beta)$æ¥æ±‚è§£$\beta$ï¼š


$$
Q(\beta)= \sum\limits_{i;t_i=0}^n  X_i e^{X_i^T \beta} \tag{11}
$$

å› ä¸ºç­‰å¼ï¼ˆ10ï¼‰çš„å·¦å¼å®é™…ä¸Šæ˜¯å…¬å¼ï¼ˆ11ï¼‰çš„æ¢¯åº¦å‡½æ•°ï¼ˆä¸€é˜¶å¯¼å‡½æ•°ï¼‰ï¼Œæ‰€ä»¥æ±‚å…¬å¼ï¼ˆ11ï¼‰çš„æå°å€¼å¯¹åº”çš„$\beta$å°±ç›¸å½“äºæ±‚è§£ç­‰å¼ï¼ˆ10ï¼‰ã€‚

è€Œç›®æ ‡å‡½æ•°çš„äºŒé˜¶å¯¼å‡½æ•°ï¼ˆå…¬å¼ï¼ˆ12ï¼‰ï¼‰å¯¹äºæ‰€æœ‰$\beta$æ¥è¯´éƒ½æ˜¯æ­£å®šçš„ï¼Œæ‰€ä»¥ç›®æ ‡å‡½æ•°$Q(\beta)$æ˜¯å‡¸å‡½æ•°ï¼Œä¸”æœ‰å…¨å±€æå°å€¼å¯¹åº”çš„å”¯ä¸€è§£ã€‚

$$
Q^{(2)}(\beta)= \sum\limits_{i;t_i=0}^n  X_i X^T_i e^{X_i^T \beta} \tag{12}
$$

åŸºäºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ç‰›é¡¿è¿­ä»£æ³•ï¼ˆNewton-Raphsonï¼‰æ±‚ç›®æ ‡å‡½æ•°ï¼ˆå…¬å¼ï¼ˆ12ï¼‰ï¼‰çš„æå°å€¼ï¼Œä¹Ÿå°±è§£å‡ºäº†ç­‰å¼ï¼ˆ10ï¼‰ï¼Œèƒ½å¾—å‡º$\beta$ï¼Œä¹Ÿå°±å¾—åˆ°äº†IPDè¯•éªŒæ‚£è€…çš„æƒé‡å€¼$w_i$ã€‚


ç†è®ºéƒ¨åˆ†ç»ˆäºå®Œç»“äº†ï¼Œæ’’èŠ±ï¼ğŸŒºğŸŒºğŸŒº

æ¥ä¸‹æ¥æ˜¯Rè¯­è¨€å®ç°ã€‚

## Rè¯­è¨€å®ç°MAIC 

ç–¾ç—…èƒŒæ™¯ï¼š

- Pï¼šmoderate to severe Psoriasisï¼ˆé“¶å±‘ç—…ï¼‰patients in North America
- Iï¼šAdalimumabï¼ˆé˜¿è¾¾æœ¨å•æŠ—-IPDï¼‰
- Cï¼šetanerceptï¼ˆä¾é‚£è¥¿æ™®ï¼‰
- Oï¼šPsoriasis Area and Severity Indexï¼ˆé“¶å±‘ç—…é¢ç§¯åŠä¸¥é‡ç¨‹åº¦æŒ‡æ•°ï¼‰
- Sï¼šNo randomized, head-to-head clinical trial has compared adalimumab with etanercept for the treatment of psoriasis.

å‡è®¾åªæœ‰å¹´é¾„å±äºæ•ˆæœä¿®é¥°å› å­ï¼Œæ€§åˆ«å±äºé¢„åå˜é‡ã€‚

ç¬¬ä¸€æ­¥ï¼Œå°†ä¸¤ç»„è¯ç‰©çš„æ•°æ®è¾“å…¥


```r
library(tidyverse)
mydata1<-tibble(id=1:10, 
                age=c(49,50,44,43,55,57,49,51,53,59),
                gender=c(0,1,0,1,0,1,1,1,0,1), 
                outcome=c(7.0,7.7,6.0,6.8,7.2,7.5,8.0,6.3,7.2,7.9))
A.IPD<-mydata1
mydata2<-tibble(age.mean=53,
                age.sd=1.290994, 
                N.male=4, 
                prop.male=0.8,
                y.B.sum=37,
                y.B.bar=7.4,
                N.B=5,
                varB=0.2)
B.AgD<-mydata2 
```

ç¬¬äºŒæ­¥ï¼Œå»ºç«‹Qï¼ˆbï¼‰åŠå…¶ä¸€é˜¶å¯¼æ•°å’Œç¦»å·®å˜æ¢


```r
#å»ºç«‹Qï¼ˆbï¼‰å‡½æ•°
objfn<- function(Î²1,X){
  sum(exp(X %*% Î²1))
}

#å»ºç«‹Qï¼ˆbï¼‰ä¸€é˜¶å¯¼æ•°
gradfn<- function(Î²1,X){
  colSums(sweep(X, 1, exp(X %*% Î²1), "*"))
}

#å¯¹åŸºçº¿ç‰¹å¾è¿›è¡Œç¦»å·®
X.EM.0<- sweep(with(A.IPD, cbind(age, age^2)), 2, 
               with(B.AgD, cbind(age.mean, age.mean^2 + age.sd^2)), "-")
```


ç¬¬ä¸‰æ­¥ï¼Œå¯¹$Q(\beta)$å‡½æ•°è¿›è¡Œæœ€å°åŒ–æ¥æ±‚å‡º$\beta$çš„å”¯ä¸€è§£


```r
print(opt1<-optim(par=c(0,0), fn=objfn, gr=gradfn, X=X.EM.0, method="BFGS"))
```

```
## $par
## [1] 36.0887332 -0.3398965
## 
## $value
## [1] 2.764361
## 
## $counts
## function gradient 
##       91       33 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
```

ç¬¬å››æ­¥ï¼Œè®¡ç®—æƒé‡å€¼


```r
Î²1<-opt1$par
wt<- exp(X.EM.0 %*% Î²1)
N.A<-c(10)
wt.rs<- (wt/sum(wt))* N.A #æ ‡å‡†åŒ–æƒé‡
summary(wt.rs)
```

```
##        V1          
##  Min.   :0.000000  
##  1st Qu.:0.005488  
##  Median :0.028501  
##  Mean   :1.000000  
##  3rd Qu.:1.151896  
##  Max.   :6.374269
```

ç¬¬äº”æ­¥ï¼Œè®¡ç®—æœ‰æ•ˆæ ·æœ¬é‡


```r
#ç”»å‡ºè°ƒæ•´åçš„æƒé‡çš„åˆ†å¸ƒå›¾
library(ggplot2)
qplot(wt.rs,geom="histogram", xlab="Rescaled weight", binwidth=0.25)
```

<img src="/courses/probability/MAIC_files/figure-html/unnamed-chunk-5-1.png" width="672" />

```r
#è®¡ç®—æœ‰æ•ˆæ ·æœ¬é‡ESS
sum(wt)^2/sum(wt^2)
```

```
## [1] 2.164168
```



ç¬¬å…­æ­¥ï¼Œè®¡ç®—åŠ æƒåçš„åŸºçº¿å¹³å‡å€¼


```r
#è®¡ç®—åŠ æƒåIPDè¯•éªŒçš„åŸºçº¿å¹³å‡å€¼å’Œæ ‡å‡†å·®
library(dplyr)
A.IPD %>%
  mutate(wt)%>%
  summarise(age.mean=weighted.mean(age, wt),
            age.sd=sqrt(sum(wt/sum(wt)*(age-age.mean)^2)))
```

```
## # A tibble: 1 Ã— 2
##   age.mean age.sd
##      <dbl>  <dbl>
## 1     53.0   1.29
```

```r
#æ±‡æ€»è¯•éªŒçš„åŸºçº¿å¹³å‡å€¼å’Œæ ‡å‡†å·®
B.AgD[, c("age.mean","age.sd")]
```

```
## # A tibble: 1 Ã— 2
##   age.mean age.sd
##      <dbl>  <dbl>
## 1       53   1.29
```

ç¬¬ä¸ƒæ­¥ï¼Œè®¡ç®—åŠ æƒåçš„åŸºçº¿å¹³å‡å€¼åŠç›¸å¯¹ç–—æ•ˆ

```r
#è®¡ç®—åŠ æƒåIPDè¯•éªŒçš„ç»“æœ
A.IPD %>%
  summarise(outcome.mean=weighted.mean(outcome,wt),
            outcome.sd=sqrt(sum(wt/sum(wt)*(outcome-outcome.mean)^2))
  )
```

```
## # A tibble: 1 Ã— 2
##   outcome.mean outcome.sd
##          <dbl>      <dbl>
## 1         7.08      0.335
```

```r
#æ±‡æ€»è¯•éªŒçš„ç»“æœ
B.AgD[,c("y.B.bar","varB")]
```

```
## # A tibble: 1 Ã— 2
##   y.B.bar  varB
##     <dbl> <dbl>
## 1     7.4   0.2
```

```r
#ç›¸å¯¹ç–—æ•ˆ
outcome.mean<-c(7.084148)
y.B.bar<-c(7.4)
outcome.sd<-c(0.3350903)
y.B.sd<-c(0.2)
print(d.AB.MAIC<-outcome.mean-y.B.bar)     
```

```
## [1] -0.315852
```

```r
print(var.d.AB.MAIC<-outcome.sd+y.B.sd)  
```

```
## [1] 0.5350903
```


